//
//  NoZ - Copyright(c) 2026 NoZ Games, LLC
//

using noz.editor;

namespace noz;

public static class AssetManifest
{
    public static void Generate(EditorConfig config)
    {
        if (config.GenerateCs != null)
            GenerateCs(config);

        if (config.GenerateLua != null)
            GenerateLua(config);
    }

    private static void GenerateCs(EditorConfig config)
    {
        var path = config.GenerateCs!;
        Directory.CreateDirectory(Path.GetDirectoryName(path) ?? ".");

        using var writer = new StreamWriter(path);

        writer.WriteLine("//");
        writer.WriteLine("//  Auto-generated by NoZ Editor - DO NOT EDIT");
        writer.WriteLine("//");
        writer.WriteLine();
        writer.WriteLine($"namespace {config.CsNamespace};");
        writer.WriteLine();
        writer.WriteLine($"public static class {config.CsClass}");
        writer.WriteLine("{");

        var documentsByType = DocumentManager.Documents
            .GroupBy(d => d.Def.Type)
            .OrderBy(g => g.Key.ToString());

        foreach (var group in documentsByType)
        {
            var typeName = group.Key.ToString();
            writer.WriteLine($"    public static class {typeName}s");
            writer.WriteLine("    {");

            foreach (var doc in group.OrderBy(d => d.Name))
            {
                var constName = ToPascalCase(doc.Name);
                writer.WriteLine($"        public const string {constName} = \"{doc.Name}\";");
            }

            writer.WriteLine("    }");
            writer.WriteLine();
        }

        writer.WriteLine("}");

        Log.Info($"Generated {path}");
    }

    private static void GenerateLua(EditorConfig config)
    {
        var path = config.GenerateLua!;
        var className = config.LuaClass;

        Directory.CreateDirectory(Path.GetDirectoryName(path) ?? ".");

        using var writer = new StreamWriter(path);

        writer.WriteLine("--");
        writer.WriteLine("--  Auto-generated by NoZ Editor - DO NOT EDIT");
        writer.WriteLine("--");
        writer.WriteLine();
        writer.WriteLine($"local {className} = {{}}");
        writer.WriteLine();

        var documentsByType = DocumentManager.Documents
            .GroupBy(d => d.Def.Type)
            .OrderBy(g => g.Key.ToString());

        foreach (var group in documentsByType)
        {
            var typeName = group.Key.ToString();
            writer.WriteLine($"{className}.{typeName}s = {{");

            foreach (var doc in group.OrderBy(d => d.Name))
            {
                var constName = ToPascalCase(doc.Name);
                writer.WriteLine($"    {constName} = \"{doc.Name}\",");
            }

            writer.WriteLine("}");
            writer.WriteLine();
        }

        writer.WriteLine($"return {className}");

        Log.Info($"Generated {path}");
    }

    private static string ToPascalCase(string name)
    {
        var sb = new System.Text.StringBuilder();
        var capitalizeNext = true;

        foreach (var c in name)
        {
            if (c == '_' || c == '-' || c == ' ')
            {
                capitalizeNext = true;
            }
            else if (capitalizeNext)
            {
                sb.Append(char.ToUpperInvariant(c));
                capitalizeNext = false;
            }
            else
            {
                sb.Append(c);
            }
        }

        return sb.ToString();
    }
}
