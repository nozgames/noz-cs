@using Microsoft.JSInterop
@using System.Runtime.InteropServices.JavaScript
@using NoZ
@using NoZ.Platform
@using NoZ.Platform.Web
@using NoZ.Platform.WebGPU
@using noz
@inject IJSRuntime JS
@implements IAsyncDisposable

<canvas id="canvas" width="@_width" height="@_height" tabindex="1"></canvas>

@code {
    [Parameter] public int Width { get; set; } = 1280;
    [Parameter] public int Height { get; set; } = 720;
    [Parameter] public string Title { get; set; } = "NoZ Game";
    [Parameter] public IApplicationVtable? Vtable { get; set; }
    [Parameter] public Func<Task>? OnInitialize { get; set; }

    private int _width;
    private int _height;
    private WebPlatform? _platform;
    private WebGPUGraphicsDriver? _driver;
    private WebAudio? _audio;
    private IJSObjectReference? _gameLoop;
    private DotNetObjectReference<WebApplication>? _dotNetRef;
    private bool _initialized;

    protected override void OnInitialized()
    {
        _width = Width;
        _height = Height;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            await InitializeGame();
        }
    }

    private async Task InitializeGame()
    {
        // Create platform, render backend, and audio driver
        _platform = new WebPlatform(JS);
        _driver = new WebGPUGraphicsDriver();
        _audio = new WebAudio(JS);

        // Initialize platform async first (web needs JS modules loaded)
        await _platform.InitAsync(new PlatformConfig
        {
            Title = Title,
            Width = _width,
            Height = _height,
            VSync = true,
            Resizable = false
        });

        await _audio.InitAsync();

        // Initialize Application with config
        Application.Init(new ApplicationConfig
        {
            Title = Title,
            Width = _width,
            Height = _height,
            Platform = _platform,
            AudioBackend = _audio,
            Vtable = Vtable,
            Graphics = new GraphicsConfig
            {
                Driver = _driver
            }
        });

        // Call user initialization
        if (OnInitialize != null)
        {
            await OnInitialize();
        }

        // Start game loop
        _dotNetRef = DotNetObjectReference.Create(this);
        _gameLoop = await JS.InvokeAsync<IJSObjectReference>("import", "/js/noz/noz-gameloop.js");
        await _gameLoop.InvokeVoidAsync("start", _dotNetRef);
    }

    [JSInvokable]
    public void GameTick(float deltaTime)
    {
        Application.RunFrame();
    }

    public async ValueTask DisposeAsync()
    {
        if (_gameLoop != null)
        {
            await _gameLoop.InvokeVoidAsync("stop");
            await _gameLoop.DisposeAsync();
        }

        _dotNetRef?.Dispose();

        Application.Shutdown();
    }
}
